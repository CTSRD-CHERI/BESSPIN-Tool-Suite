@startuml
state "Ignition start up" as IgnitionUp
IgnitionUp: Start BeamNG
IgnitionUp: Load Device Drivers
IgnitionUp: Connect to FadeCandy boards
[*] --> IgnitionUp: SimPC powered up

IgnitionUp --> IgnitionLedInitFailed: FadeCandy init failed
state "Non-critical components failed" as IgnitionLedInitFailed
IgnitionLedInitFailed: LED init failed
IgnitionLedInitFailed: Log error and continue

IgnitionLedInitFailed --> IgnitionReady: Send CMD_COMPONENT_ERROR(FADECANDY|NONCRITICAL)\nSend CMD_COMPONENT_READY(IGNITION)

IgnitionUp --> IgnitionReady: Success\nSend CMD_COMPONENT_READY(IGNITION)
state "Ignition Ready" as IgnitionReady
IgnitionReady: BeamNG up
IgnitionReady: HUD/Dashboard up
IgnitionReady: Steering wheel up
IgnitionReady: CAN_mux up

IgnitionReady -[#blue]-> ProcessCacMsg: Received C&C message
state "Process C&C Message" as ProcessCacMsg

state "C&C Message Processed" as CacMsgProcessed

CacMsgProcessed -[#blue]-> IgnitionReady

state "Switch CAN network" as SwitchCanNetwork
ProcessCacMsg -[#blue]-> SwitchCanNetwork: Rx CMD_ACTIVE_SCENARIO(SCENARIO_ID)
SwitchCanNetwork: Update active CAN network
SwitchCanNetwork --> IgnitionTerminate: CAN switch failed
SwitchCanNetwork -[#blue]-> CacMsgProcessed: Active CAN selected

ProcessCacMsg -[#blue]-> ChangeLedSequence: Rx CMD_HACK_ACTIVE(HACK_ID)
state "Change LED sequence" as ChangeLedSequence
ChangeLedSequence: change LED sequence through LED manager

ChangeLedSequence -[#blue]-> CacMsgProcessed: LED sequence changed

ProcessCacMsg -[#blue]-> RestartScenario: Rx CMD_RESTART(BEAM_NG_SCENARIO)
state "Restart Scenario" as RestartScenario
RestartScenario: car to start location
RestartScenario -[#blue]-> CacMsgProcessed: Scenario restarted
RestartScenario --> IgnitionTerminate: Restart failed

' CAN messages
state "Process CAN message" as ProcessCanMsg
IgnitionReady -[#green]-> ProcessCanMsg: Received CAN message
CanMsgProcessed -[#green]-> IgnitionReady

state "Update Gear value" as UpdateGear
ProcessCanMsg -[#green]-> UpdateGear: Rx GEAR
UpdateGear -[#green]-> CanMsgProcessed: Gear value updated

state "Update Throttle input" as ThrottleInput
ProcessCanMsg -[#green]-> ThrottleInput: Rx THROTTLE_INPUT
ThrottleInput -[#green]-> CanMsgProcessed: Throttle value updated

state "Update Brake input" as BrakeInput
ProcessCanMsg -[#green]-> BrakeInput: Rx BRAKE_INPUT
BrakeInput -[#green]-> CanMsgProcessed: Brake value updated

state "Update Steering input" as SteeringInput
SteeringInput: LKAS
ProcessCanMsg -[#green]-> SteeringInput: Rx STEERING_INPUT
SteeringInput -[#green]-> CanMsgProcessed: Steering value updated


IgnitionUp --> IgnitionTerminate: Startup Failed\n

state "Ignition terminate" as IgnitionTerminate
IgnitionTerminate: Orderly shutdown

IgnitionReady --> IgnitionTerminate: Sub-Component failed

IgnitionTerminate --> [*]: Send CMD_COMPONENT_ERROR(IGNITION|TERMINATED)

@enduml
